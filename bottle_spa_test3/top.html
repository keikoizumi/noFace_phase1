<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>noFace</title>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript">
//グローバル変数
var items = [];
var otherOne = 'yahoo';
var otherTow = 'buzzfeed';
//上限回数       
var setTimes = 100;
//チェック関数
function checkId(data){
         var id = '';
         id = data.id;
         //見つからない場合は-1
         if (items.indexOf(id) == -1){
            if (checkTimes(items)) {
              items.push(id);    
              addTags(data);
              console.log('通信成功');
              console.log(data);
              console.log('items');
              console.log(items);
              console.log('-------------------------------------------------------------');
            }
         } else { 
          　if (checkTimes(items)) {
              items.push('NG');
              getUrl();
            } else {
              items.push('NG');
            } 
         }  
}
function today(){
  var today = new Date();
  var year = today.getFullYear();
  var month = today.getMonth() + 1;
  var day = today.getDate();
  var formatedDate = year + '-' + month + '-' + day ; 
  return formatedDate
 console.log( formatedDate);

}

function addTags(data){
  $(function() {
    $('ul').append('<li><a href='+data.url+' target="_blank">'+'['+data.dt+']'+data.title+'</a></li>');
  });
  $(function() {
    $('#iframe').append('<iframe src='+'"'+data.url+'"'+'width=1250 height=500>'+'</iframe>');
  });
  
}

function show(data){
  $(function() {
    for (var i = 0; i < data.length; i++) {
      $('ul').append('<li><a href='+data[i].url+' target="_blank">'+'['+data[i].dt+']'+data[i].title+'</a></li>');
    }  
  });
}


function checkTimes(items){
    if (items.length >= (setTimes)){
        alert('上限回数を超えました。リロードされます。');
        window.location.reload();
        return false;
    } else {
        return true;
    }   
}

function random(){
  
  $(function(){
    var targetUrl = 'http://localhost:8080/random';
    var date = today();
    var request = {
        'date' : date
    };
      $.ajax({
          url: targetUrl,
          type: 'POST',
          contentType: 'application/JSON',
          dataType: 'JSON',
          data : JSON.stringify(request),
          scriptCharset: 'utf-8',
      }).done(function(data){ 
          /* 通信成功時 */
          checkId(data);         
        }).fail(function(data, XMLHttpRequest, textStatus){
          /* 通信失敗時 */
          alert('通信失敗');
          console.log('通信失敗');
          console.log(data);
          console.log("XMLHttpRequest : " + XMLHttpRequest.status);
          console.log("textStatus     : " + textStatus);
      });
  });
}

function all(){
  $(function(){
    var targetUrl = 'http://localhost:8080/all';
    var date = today();
    var request = {
        'date' : date
    };
      $.ajax({
          url: targetUrl,
          type: 'POST',
          contentType: 'application/JSON',
          dataType: 'JSON',
          data : JSON.stringify(request),
          scriptCharset: 'utf-8',
      }).done(function(data){ 
          /* 通信成功時 */
          show(data);         
        }).fail(function(data, XMLHttpRequest, textStatus){
          /* 通信失敗時 */
          alert('通信失敗');
          console.log('通信失敗');
          console.log(data);
          console.log("XMLHttpRequest : " + XMLHttpRequest.status);
          console.log("textStatus     : " + textStatus);
      });
  });
}

function other(other){

  var targetUrl = 'http://localhost:8080/other'
  var date = today();

  if (other == otherOne) {
    var request = {
        'date' : date,
        'other':otherOne
    };
  } else if (other == otherTow) {
    var request = {
        'date' : date,
        'other':otherTow
    };  
  } else {
    console.log('NG');
  }

  $(function(){
      $.ajax({
          url: targetUrl,
          type: 'POST',
          contentType: 'application/JSON',
          dataType: 'JSON',
          data : JSON.stringify(request),
          scriptCharset: 'utf-8',
      }).done(function(data){ 
          /* 通信成功時 */
          show(data); 
          console.log(data);        
        }).fail(function(data, XMLHttpRequest, textStatus){
          /* 通信失敗時 */
          alert('通信失敗');
          console.log('通信失敗');
          console.log(data);
          console.log("XMLHttpRequest : " + XMLHttpRequest.status);
          console.log("textStatus     : " + textStatus);
      });
  });
}

$(function(){
  $('.random').on('click',function(){
    random();
  });
});

$(function(){
  $('.all').on('click',function(){
    all();    
    console.log('all');
  });
});

$(function(){
  
  $('.other').on('click',function(){
    
    var id = $(this).attr('id');
    console.log(id);
    if (id == otherOne) {
      other(otherOne);
    } else if (id == otherTow) {
      other(otherTow);
    }

  });
});

$(function(){
  $('.reset').on('click',function(){
    window.location.reload();
  });
});

</script>
</head>
<body>
  <!-- ifram -->
  <input type="button" class="random" value="noFace(random)"/>
  <!-- 遷移 -->
  <form action=''> 
    <input type="button" class="all" value="today(all)"/>
  </form>
  <!-- 遷移 -->
  <form> 
    <input type="button" class="other" id="yahoo" value="today(Yahoo)"/> 
  </form>
  <!-- 遷移 -->
  <from>
    <input type="button" class="other" id="buzzfeed" value="today(BuzzFeed)"/> 
  </from>
  <!-- リセット -->
</br>
  <input type="button" class="reset" value="reset"/>
  <ul>
  </ul>
  <div id='iframe'></div>
</body>
</html>